FROM quay.io/fedora/fedora-kinoite:latest AS base

RUN rpm-ostree install --idempotent \
        https://download1.rpmfusion.org/free/fedora/rpmfusion-free-release-$(rpm -E %fedora).noarch.rpm \
        https://download1.rpmfusion.org/nonfree/fedora/rpmfusion-nonfree-release-$(rpm -E %fedora).noarch.rpm

FROM base AS clean_base_packages

RUN rpm-ostree uninstall --idempotent \
	default-editor \
	firefox \
	firefox-langpacks \
	intel-audio-firmware \
	intel-gmmlib \
	intel-gpu-firmware \
	intel-mediasdk \
	intel-vpl-gpu-rt \
	intel-vsc-firmware \
	kwrite \
	libva-intel-media-driver \
	nano \
	nano-default-editor \
	nvidia-gpu-firmware \
	plasma-welcome-fedora

RUN rpm-ostree uninstall --idempotent \
        ffmpeg-free \
        libavcodec-free \
        libavdevice-free \
        libavfilter-free \
        libavformat-free \
        libavutil-free \
        libpostproc-free \
        libswresample-free \
        libswscale-free

FROM clean_base_packages AS install_basic_packages

RUN rpm-ostree install --idempotent \
        ffmpeg \
        ffmpeg-libs \
        ffmpegthumbnailer \
        gstreamer1-libav

COPY files/ghostty.repo /etc/yum.repos.d/ghostty.repo
COPY files/koi.repo /etc/yum.repos.d/koi.repo

RUN rpm-ostree install --idempotent \
	ddcutil \
	distrobox \
	dkms \
	efibootmgr \
	ghostty \
	git \
	hdparm \
	just \
	kernel-devel \
	Koi \
	libgda \
	libgda-sqlite \
	libnotify \
	lm_sensors \
	nvme-cli \
	openssl \
	openssl-devel \
	python3-pyclip \
	sdparm \
	smartmontools \
	sshfs \
	stow \
	wl-clipboard

# mesa-va-drivers-freeworld \
# mesa-vdpau-drivers-freeworld \

FROM install_basic_packages AS final_stage

COPY files/rpm-ostreed.conf /etc/rpm-ostreed.conf

RUN mkdir -p /etc/systemd/system/multi-user.target.wants && \
	ln -s /usr/lib/systemd/system/rpm-ostreed-automatic.timer /etc/systemd/system/timers.target.wants/

RUN rm -rf /var/* ~/.*
RUN rpm-ostree cleanup -m
RUN ostree container commit
